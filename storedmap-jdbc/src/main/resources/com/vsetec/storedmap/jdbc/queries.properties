# Copyright 2018 Fyodor Kravchenko <fedd@vsetec.com>.
#
# Licensed under the Apache License, Version 2.0 (the "License");
# you may not use this file except in compliance with the License.
# You may obtain a copy of the License at
#
#      http://www.apache.org/licenses/LICENSE-2.0
#
# Unless required by applicable law or agreed to in writing, software
# distributed under the License is distributed on an "AS IS" BASIS,
# WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
# See the License for the specific language governing permissions and
# limitations under the License.

#create index @{indexName}_lock_ind on @{indexName}_lock (createdat);\

create=create table @{indexName} (id varchar(200) primary key, val blob);\
create table @{indexName}_lock (id varchar(200) primary key, createdat timestamp, waitfor integer);\
create table @{indexName}_text (id varchar(200) primary key, ind clob);\
create table @{indexName}_tags (id varchar(200), tag varchar(200), primary key (tag, id));\
create table @{indexName}_sort (id varchar(200) primary key, sort varchar(500));\
create index @{indexName}_sort_ind on @{indexName}_sort (sort)
check=select id from @{indexName} where id is null

selectLock=select current_timestamp, createdat, waitfor from @{indexName}_lock where id=?
insertLock=insert into @{indexName}_lock (id, createdat, waitfor) values (?, current_timestamp, ?)
updateLock=update @{indexName}_lock set createdat=current_timestamp, waitfor=? where id=?
deleteLock=delete from @{indexName}_lock where id=?
deleteLocks=delete from @{indexName}_lock where createdat < ?

selectById=select val from @{indexName} where id=?
selectAll=select id from @{indexName}
#selectByVal=select id from @{indexName}_text where id like ?
selectByTags=select distinct id from @{indexName}_tags where tag in (@foreach{item:tags}? @end{', '})
selectFilterSorted=select id from @{indexName}_sort\
@if{minSorter==null}@if{maxSorter==null}@else{} where sort<=?@end{}\
@else{}@if{maxSorter==null} where sort>?@else{} where sort>? and sort<=?@end{}@end{} \
order by sort @if{!ascending} desc@end{}
selectByTagsAndFilterSorted=select distinct @{indexName}_sort.id from @{indexName}_sort \
inner join @{indexName}_tags on @{indexName}_sort.id=@{indexName}_tags.id\
@if{minSorter==null}@if{maxSorter==null}@else{} where sort<=? and @end{}\
@else{}@if{maxSorter==null} where sort>? and @else{} where sort>? and sort<=? and @end{}@end{} \
tag in (@foreach{item:tags}? @end{', '})\
order by sort @if{!ascending} desc@end{}

deleteIndex=delete from @{indexName} where id=?
deleteText=delete from @{indexName}_clob where id=?
deleteTags=delete from @{indexName}_tags where id=?
deleteSort=delete from @{indexName}_sort where id=?

insertIndex=insert into @{indexName} (id, val) values (?, ?)
insertText=insert into @{indexName}_text (id, ind) values (?, ?)
insertTag=insert into @{indexName}_tags (id, tag) values (?, ?)
insertSort=insert into @{indexName}_sort (id, sort) values (?, ?)

